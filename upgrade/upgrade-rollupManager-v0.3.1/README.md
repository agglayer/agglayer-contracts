# Upgrade RollupManager al-v0.3.1

Script to create schedule and execute transaction for upgrading PolygonRollupManager, globalExitRootManager and BridgeV2

## Setup

- install packages

```
npm i
```

- Set env variables

```
cp .env.example .env
```

Fill `.env` with your `ETHERSCAN_API_KEY` and `DEPLOYER_PRIVATE_KEY`

- Copy configuration files:

```
cp ./upgrade/upgrade-rollupManager-v0.3.1/upgrade_parameters.json.example ./upgrade/upgrade-rollupManager-v0.3.1/upgrade_parameters.json
```

- Fill configuration file

    - "tagSCPreviousVersion": -> The smart contract tag of the previous upgrade version
    - "rollupManagerAddress": "0x.." -> Address of the rollup manager proxy to upgrade
    - "timelockDelay": 3600, -> the timelock delay between schedule and execution transaction
    - "timelockSalt": "" -> Optional: A unique salt used to identify and secure the operation
    - "maxFeePerGas": "", -> Optional: Set `maxFeePerGas`, must define as well `maxPriorityFeePerGas` to use it
    - "maxPriorityFeePerGas": "", -> Optional: Set `maxPriorityFeePerGas`, must define as well `maxFeePerGas` to use it
    - "multiplierGas": "", -> Optional: Gas multiplier with 3 decimals. If `maxFeePerGas` and `maxPriorityFeePerGas` are set, this will not take effect
    - "forkParams"
      - "rpc": "rpc url" -> Optional: only used for shallow fork testing, is the rpc of the node to fork

- Run tool:

```
npx hardhat run ./upgrade/upgrade-rollupManager-v0.3.1/upgrade-rollupManager-v0.3.1.ts --network sepolia
```
- OutputFile: `upgrade_output.json`

```
{
  "tagSCPreviousVersion": "v10.1.0-rc.5",
  "gitInfo": {
    "commit": "0704e130563fa6808ef3e5bc678e34f438253289",
    "repo": "git@github.com:agglayer/agglayer-contracts.git"
  },
  "scheduleData": "0x01d5062a000000000000000000000000e9e0baae3eeb4f0d1a2e8cd36ceb61ab8ad83f95000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000000000000000000000000000000000000000000000000000000000a49623609d000000000000000000000000e2ef6215adc132df6913c8dd16487abf118d1764000000000000000000000000f8747659957f292efe6f907667b2cabcd840efb3000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000048129fc1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "executeData": "0x134008d3000000000000000000000000e9e0baae3eeb4f0d1a2e8cd36ceb61ab8ad83f95000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a49623609d000000000000000000000000e2ef6215adc132df6913c8dd16487abf118d1764000000000000000000000000f8747659957f292efe6f907667b2cabcd840efb3000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000048129fc1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "timelockContractAddress": "0xf653Fd9e2658c5A21d23Abd01C60D112bA6FFe65",
  "implementationDeployBlockNumber": 8518797,
  "decodedScheduleData": {
    "target": "0xe9E0BAAe3eEB4F0D1A2e8cd36CEB61Ab8ad83f95",
    "value": 0,
    "data": "0x9623609d000000000000000000000000e2ef6215adc132df6913c8dd16487abf118d1764000000000000000000000000f8747659957f292efe6f907667b2cabcd840efb3000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000048129fc1c00000000000000000000000000000000000000000000000000000000",
    "decodedData": {
      "signature": "upgradeAndCall(address,address,bytes)",
      "selector": "0x9623609d",
      "proxy": "0xE2EF6215aDc132Df6913C8DD16487aBF118d1764",
      "implementation": "0xf8747659957F292EFe6F907667b2cabCD840Efb3",
      "data": "0x8129fc1c"
    },
    "predecessor": "0x0000000000000000000000000000000000000000000000000000000000000000",
    "salt": "0x0000000000000000000000000000000000000000000000000000000000000000",
    "delay": 60
  },
  "deployedContracts": {
    "rollupManagerImplementation": "0xf8747659957F292EFe6F907667b2cabCD840Efb3"
  }
}
```

This JSON file contains the parameters generated by our upgrade script. Below is a breakdown of each field:

- **scheduleData**:  
  The ABI-encoded data that represents the timelock scheduling call. It contains all parameters (target, value, data, predecessor, salt, delay) that the timelock contract will store when the upgrade operation is scheduled.

- **executeData**:  
  The ABI-encoded data for the timelock execution call. This is used later to execute the scheduled operation, triggering the proxy upgrade and any initialization.

- **timelockContractAddress**:  
  The address of the Timelock contract that will manage the delay and execution of the upgrade operation.

- **implementationDeployBlockNumber**:
  The block number where the implementation contract was deployed. It is used for testing purposes on the shallow fork test

- **decodedScheduleData**:  
  A human-readable object that decodes the contents of the scheduled operation:

    - **target**:  
      The contract address that will be called by the timelock (typically the ProxyAdmin contract).
    - **value**:  
      The ETH value to send with the call (usually 0).
    - **data**:  
      The raw encoded data representing the upgrade call (e.g., `upgradeAndCall` with proxy, new implementation, and initialization data).
    - **decodedData**:  
      A further breakdown of the `data` field:
        - **signature**: The function signature being called (e.g., `"upgradeAndCall(address,address,bytes)"`).
        - **selector**: The first 4 bytes of the ABI-encoded function call.
        - **proxy**: The proxy contract address that will be upgraded.
        - **implementation**: The address of the new implementation contract.
        - **data**: The ABI-encoded initialization call for the new implementation.
    - **predecessor**:  
      The hash of a prior operation that must complete before this one; if none exists, this is zero.
    - **salt**:  
      A unique salt used to identify and secure the operation.
    - **delay**:  
      The timelock delay (in seconds) required before the scheduled operation can be executed (e.g., "3600" means a one-hour delay).

This structure allows us to verify and audit every aspect of the upgrade operation before it is executed.

## Testing with shallow fork
A test is included to check everything will go alright before executing the timelock transactions.
Run the shallow fork test with:
````
npx hardhat test ./upgrade/upgrade-rollupManager-v0.3.1/upgrade-rollupManager-v0.3.1.test.ts
````
