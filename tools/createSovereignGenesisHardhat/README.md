
> ⚠️ **Warning:** This code has not been audited yet.

# Create sovereign genesis
Script to generate the genesis file for a rollup with `SovereignContracts`. This genesis is aimed to be used for chains that are run with vanilla clients.
This script should be run after the rollup is created, so its `rollupID` and the bridge initialization parameters are known.
The script does the following:
- read base genesis file
- deploy sovereign contracts
- initialize them

## Setup
- install packages
```
npm i
```

- Set env variables
````
cp .env.example .env
````

Fill `.env` with your `INFURA_PROJECT_ID` and `ETHERSCAN_API_KEY`

- Copy configuration files:
```
cp ./tools/createSovereignGenesisHardhat/create-genesis-sovereign-params.json.example ./tools/createSovereignGenesisHardhat/create-genesis-sovereign-params.json
```

- Copy genesis base file:
```
cp ./tools/createSovereignGenesisHardhat/genesis-base.json.example ./tools/createSovereignGenesisHardhat/genesis-base.json
```

-  Set your parameters
  - `rollupManagerAddress`: `polygonRollupManager` smart contract address
  - `rollupID`: Rollup identifier. Assigned to a rollup when it is created in the contracts
  - `chainID`: ChainID of the rollup
  - `gasTokenAddress`: Address of the native gas token of the rollup, zero if ether
  - `bridgeManager`: bridge manager address
  - `sovereignWETHAddress`: sovereign WETH address
  - `sovereignWETHAddressIsNotMintable`: Flag to indicate if the wrapped ETH is not mintable
  - `globalExitRootUpdater`: Address of globalExitRootUpdater for sovereign chains (if `useAggOracleCommittee == false`)
  - `globalExitRootRemover`: Address of globalExitRootRemover for sovereign chains
  - `emergencyBridgePauser`: emergency bridge pauser address, can stop the bridge, recommended to be a multisig
  - `emergencyBridgeUnpauser`: emergency bridge unpauser address, can unpause the bridge, recommended to be a multisig
  - `setPreMintAccount`: indicates if a preMint accounts going to be added
    - `preMintAccount.address`: ethereum address to receive an initial balance
    - `preMintAccount.balance`: balance credited to the preminted address
  - `setTimelockParameters`: indicates if the timelock parameters are going to be changed
    - `timelockParameters.adminAddress`: address that will have all timelocks roles (ADMIN, PROPOSER, CANCELLER, EXECUTOR)
    - `timelockParameters.minDelay`: minimum delay set in the timelock smart contract
  - `useAggOracleCommittee`: `true/false`. Indicates if use aggOracleCommittee
  - if `useAggOracleCommittee == true`:
    - `aggOracleOwner`: Address that will own the AggOracleCommittee contract (typically a timelock contract)
    - `aggOracleCommittee`: Array of addresses that will act as initial oracle members
    - `quorum`: Number of oracle members that must agree on a GER for it to be consolidated (must be <= aggOracleMembers.length and > 0)

- Optional parameters
  - `format`: choose genesis output format. Supported ones: `geth`
  - `debug`: to print more info

-  Run tool:
```
npx hardhat run ./tools/createSovereignGenesisHardhat/create-sovereign-genesis-hardhat.ts --network sepolia
```

### More Info
- All commands are done from root repository
- The output files are:
  - `genesis-rollupID-${rollupID}__${timestamp}`: genesis file
  - `output-rollupID-${rollupID}__${timestamp}`: input parameters, gastokenAddress information and network used
- outputs are saved in the tool folder: `./tools/createSovereignGenesisHardhat`

## Changes vs updateVanilla

In this section, we will compare the differences between the genesis generated by the `updateVanilla` function and this tool, while using the same `genesis_base` and identical parameters.

The main change consists of performing a completely new deployment while preserving the addresses of the bridge and the ger (so that it is the same as in L1). Consequently, all other addresses differ, which also affects certain storage slots and their corresponding values. This occurs because addresses are stored and, in some cases, used in the calculation of storage slots, particularly in mappings.

We will outline some of the changes identified in the following lines:

- The `PolygonZkEVMDeployer` has been removed, as it is no longer used. And the other addresses in de genesis base have been removed too.

- **Proxys bytecode**: Although we have mentioned that the proxy addresses are preserved, the bytecode changes. Previously, it was compiled with version `0.8.17`, while in this case it is compiled with version `0.8.28`:
  - https://github.com/agglayer/agglayer-contracts/blob/v4.0.0-fork.7/deployment/v2/3_deployContracts.ts#L283
    - `"@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol:TransparentUpgradeableProxy"`
  - https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v4.8.2/contracts/proxy/transparent/TransparentUpgradeableProxy.sol#L4
    - `pragma solidity ^0.8.0;`
  - https://github.com/agglayer/agglayer-contracts/blob/v4.0.0-fork.7/hardhat.config.ts#L31
    - compiler version: `0.8.17`
  - Now compiler version: `0.8.28`
    - https://github.com/agglayer/agglayer-contracts/blob/feature/v12/hardhat.config.ts#L119

- `PolygonZkEVMTimelock`: There is a timelock slot that changes, as it depends on its address.
  - `_setupRole(TIMELOCK_ADMIN_ROLE, address(this))`

- `ProxyAdmin`:
  - Old ProxyAdmin: https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v4.8.2/contracts/proxy/transparent/ProxyAdmin.sol
  - New ProxyAdmin: https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v5.0.0/contracts/proxy/transparent/ProxyAdmin.sol
  - Storage (slot 0): `PolygonZkEVMTimelock` address

- BridgeL2SovereignChain implementation bytecode: constructor addressess
  - BytecodeStorer
  - TokenWrapped implementation

- BridgeL2SovereignChain proxy storage:
  - `0x6c`: Previously, this slot didn’t show up because its value was 0. Now it shows up because, even though it’s 0, we perform an SSTORE in a transaction.
  - `0x6f`: Weth proxy
  - Implementation address slot (`0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc`) & admin address slot(`0xb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103`): diferent addresses

- GlobalExitRootManagerL2SovereignChain proxy:
    - `0x34`: AggOracleCommittee proxy
    - Implementation address slot (`0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc`) & admin address slot(`0xb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103`): diferent addresses
  
- Weth proxy storage:
  - `0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc`: TokenWrapped implementation address
  - `0xa16a46d94261c7517cc8ff89f61c0ce93598e3c849801011dee649a6a557d100` & `0xa16a46d94261c7517cc8ff89f61c0ce93598e3c849801011dee649a6a557d101`: Previously, this slot didn’t show up because its value was 0. Now it shows up because, even though it’s 0, we perform an SSTORE in a transaction.

- AggOracleCommittee proxy storage:
  - New impl address
  - New admin address

